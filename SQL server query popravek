WITH SKUPNO AS (
  SELECT YEAR(ORDERDATE) AS LETO, SUM(UNITPRICE * QTY) AS PRODAJA_LETO
  FROM ORDERS AS ORD
  JOIN ORDERDETAILS AS ORDDET ON ORDDET.ORDERID = ORD.ORDERID
  GROUP BY YEAR(ORDERDATE)
),
YEARDATA AS (
  SELECT YEAR(ORDERDATE) AS LETO, MONTH(ORDERDATE) AS MESEC, SUM(UNITPRICE * QTY) AS PRODAJA
  FROM ORDERS AS ORD
  JOIN ORDERDETAILS AS ORDDET ON ORDDET.ORDERID = ORD.ORDERID
  GROUP BY YEAR(ORDERDATE), MONTH(ORDERDATE)
)
SELECT YEARDATA.LETO, MESEC, PRODAJA, PRODAJA / PRODAJA_LETO * 100 AS DELEZ_PRODAJE
FROM YEARDATA 
JOIN SKUPNO ON SKUPNO.LETO = YEARDATA.LETO
ORDER BY LETO DESC, MESEC ASC;
