--NALOGA1

SELECT CATEGORYNAME, SUM(ORD.UNITPRICE * QTY * (1 - DISCOUNT)) AS PRODAJA, SUM(ORD.UNITPRICE * QTY) / SUM(QTY) AS POVP_CENA, COUNT(ORD.ORDERID) AS ST_NAROCIL
FROM PRODUCTION.CATEGORIES AS CAT
JOIN PRODUCTION.PRODUCTS AS PROD ON CAT.CATEGORYID = PROD.CATEGORYID
JOIN SALES.ORDERDETAILS AS ORD ON ORD.PRODUCTID = PROD.PRODUCTID
GROUP BY CATEGORYNAME;


--NALOGA2

WITH AGEDATA AS 
(
  SELECT CONCAT(FIRSTNAME,' ', LASTNAME) AS IME_PRIIMEK, 
    CASE 
    WHEN DAYOFYEAR(CURRENT_DATE()) >= DAYOFYEAR(BIRTHDATE) THEN DATEDIFF(YEAR, BIRTHDATE, CURRENT_DATE())
    ELSE DATEDIFF(YEAR, BIRTHDATE, CURRENT_DATE()) - 1 
  END AS STAROST
  FROM HR.EMPLOYEES
),

STAROST_SKUPINE AS 
(
  SELECT IME_PRIIMEK, STAROST,
    CASE WHEN STAROST < 25 THEN '< 25'
    WHEN STAROST >= 25 AND STAROST < 40 THEN '25 - 40'
    WHEN STAROST >= 40 AND STAROST < 60 THEN '40 - 60'
    WHEN STAROST >= 60 THEN '> 60'
   END AS RAZRED_STAROSTI
   FROM AGEDATA 
)

SELECT RAZRED_STAROSTI, COUNT(DISTINCT IME_PRIIMEK)
FROM STAROST_SKUPINE
GROUP BY RAZRED_STAROSTI
;

--NALOGA2 POPRAVEK

WITH AGEDATA AS 
(
  SELECT CONCAT(FIRSTNAME,' ', LASTNAME) AS IME_PRIIMEK, 
    CASE 
    WHEN DAYOFYEAR(CURRENT_DATE()) >= DAYOFYEAR(BIRTHDATE) THEN DATEDIFF(YEAR, BIRTHDATE, CURRENT_DATE())
    ELSE DATEDIFF(YEAR, BIRTHDATE, CURRENT_DATE()) - 1 
  END AS STAROST
  FROM HR.EMPLOYEES
),

STAROST_SKUPINE AS 
(
  SELECT IME_PRIIMEK, STAROST,
    CASE WHEN STAROST < 25 THEN '< 25'
    WHEN STAROST < 40 THEN '25 - 40'
    WHEN STAROST < 60 THEN '40 - 60'
    ELSE '> 60'
   END AS RAZRED_STAROSTI
   FROM AGEDATA 
)

SELECT RAZRED_STAROSTI, COUNT(DISTINCT IME_PRIIMEK)
FROM STAROST_SKUPINE
GROUP BY RAZRED_STAROSTI
;

--NALOGA3

WITH EMPDATA AS 
(
SELECT HR.EMPID, CONCAT(FIRSTNAME, ' ', LASTNAME) AS IME_PRIIMEK, ORD.ORDERID, ORDERDATE, SUM(UNITPRICE * QTY) AS PRODAJA
  FROM HR.EMPLOYEES AS HR 
  JOIN SALES.ORDERS AS ORD ON ORD.EMPID = HR.EMPID
  JOIN SALES.ORDERDETAILS AS ORDDET ON ORDDET.ORDERID = ORD.ORDERID
  GROUP BY HR.EMPID, IME_PRIIMEK, ORD.ORDERID, ORDERDATE
),
TOPEMP AS (
  SELECT EMPID, SUM(PRODAJA) AS PRODAJA
  FROM EMPDATA
  WHERE YEAR(ORDERDATE) = 2015 AND MONTH(ORDERDATE) = 1
  GROUP BY EMPID
  ORDER BY PRODAJA DESC
  LIMIT 5
)
SELECT IME_PRIIMEK, SUM(PRODAJA) AS PRODAJA
FROM EMPDATA 
WHERE ORDERDATE BETWEEN '2015-02-01' AND '2015-02-15' AND EMPID NOT IN(
  SELECT EMPID
  FROM TOPEMP)
GROUP BY IME_PRIIMEK
ORDER BY PRODAJA DESC;

--NALOGA4

WITH SKUPNO AS (
  SELECT YEAR(ORDERDATE) AS LETO, SUM(UNITPRICE * QTY) AS PRODAJA_LETO
  FROM SALES.ORDERS AS ORD
  JOIN SALES.ORDERDETAILS AS ORDDET ON ORDDET.ORDERID = ORD.ORDERID
  GROUP BY LETO
),
YEARDATA AS (
  SELECT YEAR(ORDERDATE) AS LETO, MONTH(ORDERDATE) AS MESEC, SUM(UNITPRICE * QTY) AS PRODAJA
  FROM SALES.ORDERS AS ORD
  JOIN SALES.ORDERDETAILS AS ORDDET ON ORDDET.ORDERID = ORD.ORDERID
  GROUP BY LETO, MESEC
)
SELECT YEARDATA.LETO, MESEC, PRODAJA, PRODAJA / PRODAJA_LETO * 100 AS DELEZ_PRODAJE
FROM YEARDATA 
JOIN SKUPNO ON SKUPNO.LETO = YEARDATA.LETO
ORDER BY LETO DESC, MESEC ASC;

--NALOGA5

SELECT PRODUCTNAME
FROM PRODUCTION.PRODUCTS AS PROD
JOIN SALES.ORDERDETAILS AS ORDDET ON ORDDET.PRODUCTID = PROD.PRODUCTID
JOIN SALES.ORDERS AS ORD ON ORD.ORDERID = ORDDET.ORDERID
WHERE YEAR(ORDERDATE) = '2015'
GROUP BY PRODUCTNAME
HAVING COUNT(DISTINCT MONTH(ORDERDATE)) = 12;
